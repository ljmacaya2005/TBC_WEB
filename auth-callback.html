<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Verification - The Brew Cave</title>
    <link rel="icon" type="image/x-icon" href="assets/icon.png">

    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/swal2.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .callback-container {
            background: white;
            padding: 50px 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(166, 123, 91, 0.2);
            border-top-color: #A67B5B;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 15px;
        }

        p {
            color: #666;
            font-size: 16px;
            line-height: 1.6;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            display: none;
        }

        .success-icon svg {
            width: 100%;
            height: 100%;
            fill: #A67B5B;
        }

        .error-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            display: none;
        }

        .error-icon svg {
            width: 100%;
            height: 100%;
            fill: #e74c3c;
        }

        .redirect-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            font-size: 14px;
            color: #666;
        }

        .btn-continue {
            display: inline-block;
            margin-top: 25px;
            padding: 12px 30px;
            background: #A67B5B;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-continue:hover {
            background: #8d6849;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(166, 123, 91, 0.3);
        }
    </style>
</head>

<body>
    <div class="callback-container">
        <div class="spinner" id="spinner"></div>
        <div class="success-icon" id="successIcon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        </div>
        <div class="error-icon" id="errorIcon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
        </div>

        <h1 id="statusTitle">Verifying Email...</h1>
        <p id="statusMessage">Please wait while we confirm your email change.</p>

        <div class="redirect-info" id="redirectInfo" style="display: none;">
            Redirecting to your profile in <strong id="countdown">3</strong> seconds...
        </div>

        <a href="profile.html" class="btn-continue" id="continueBtn" style="display: none;">
            Continue to Profile
        </a>
    </div>

    <script>
        (async function () {
            const spinner = document.getElementById('spinner');
            const successIcon = document.getElementById('successIcon');
            const errorIcon = document.getElementById('errorIcon');
            const statusTitle = document.getElementById('statusTitle');
            const statusMessage = document.getElementById('statusMessage');
            const redirectInfo = document.getElementById('redirectInfo');
            const continueBtn = document.getElementById('continueBtn');
            const countdownEl = document.getElementById('countdown');

            try {
                // Get hash parameters from URL
                const hash = window.location.hash.substring(1);
                const params = new URLSearchParams(hash);
                const message = params.get('message');
                const error = params.get('error');
                const errorDescription = params.get('error_description');

                // Check for errors
                if (error) {
                    throw new Error(errorDescription || error);
                }

                // Wait a moment for Supabase to process
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Get current session
                const { data: { session }, error: sessionError } = await window.sb.auth.getSession();

                if (sessionError) throw sessionError;

                // Success!
                spinner.style.display = 'none';
                successIcon.style.display = 'block';
                statusTitle.textContent = 'Email Verified Successfully! âœ“';
                statusMessage.textContent = message || 'Your email has been updated. You can now continue using your account.';

                // Show redirect countdown
                redirectInfo.style.display = 'block';
                continueBtn.style.display = 'inline-block';

                // Countdown and redirect
                let seconds = 3;
                const countdown = setInterval(() => {
                    seconds--;
                    countdownEl.textContent = seconds;
                    if (seconds <= 0) {
                        clearInterval(countdown);
                        window.location.href = 'profile.html';
                    }
                }, 1000);

            } catch (err) {
                console.error('Verification error:', err);

                spinner.style.display = 'none';
                errorIcon.style.display = 'block';
                statusTitle.textContent = 'Verification Failed';
                statusMessage.textContent = err.message || 'There was a problem verifying your email. Please try again or contact support.';

                continueBtn.style.display = 'inline-block';
                continueBtn.textContent = 'Back to Profile';
            }
        })();
    </script>
</body>

</html>